"""
–ú–æ–¥—É–ª—å –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å OpenAI (ChatGPT) API.
–ê–Ω–∞–ª–∏–∑ –Ω–æ–≤–æ—Å—Ç–µ–π, –æ—Ü–µ–Ω–∫–∞ —Ö–∞–π–ø–∞, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–æ–≤.
"""

import json
import logging
from typing import Optional

from openai import AsyncOpenAI

from config import OPENAI_API_KEY, OPENAI_MODEL
from scraper import NewsItem

logger = logging.getLogger(__name__)

client = AsyncOpenAI(api_key=OPENAI_API_KEY)


async def analyze_news_batch(news_items: list[NewsItem]) -> list[NewsItem]:
    """
    –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∞—á–∫—É –Ω–æ–≤–æ—Å—Ç–µ–π –≤ ChatGPT –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ö–∞–π–ø–∞.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –Ω–æ–≤–æ—Å—Ç–µ–π —Å –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º–∏ hype_score –∏ summary –Ω–∞ —Ä—É—Å—Å–∫–æ–º.
    """
    if not news_items:
        return []

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –Ω–æ–≤–æ—Å—Ç–µ–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
    news_list = []
    for i, item in enumerate(news_items):
        news_list.append({
            "index": i,
            "title": item.title,
            "source": item.source,
            "summary": item.summary[:300],
        })

    prompt = f"""–¢—ã ‚Äî –∞–Ω–∞–ª–∏—Ç–∏–∫ –Ω–æ–≤–æ—Å—Ç–µ–π –§–æ—Ä–º—É–ª—ã 1. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ –∏ –¥–ª—è –∫–∞–∂–¥–æ–π:

1. –ü–æ—Å—Ç–∞–≤—å –æ—Ü–µ–Ω–∫—É "—Ö–∞–π–ø–∞" –ø–æ —à–∫–∞–ª–µ –æ—Ç 1 –¥–æ 10, –≥–¥–µ:
   - 10: –°–µ–Ω—Å–∞—Ü–∏—è (—Å–º–µ–Ω–∞ –ø–∏–ª–æ—Ç–∞ —Ç–æ–ø-–∫–æ–º–∞–Ω–¥—ã, —Å–µ—Ä—å—ë–∑–Ω–∞—è –∞–≤–∞—Ä–∏—è, –¥–∏—Å–∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è, —Å–∫–∞–Ω–¥–∞–ª)
   - 8-9: –û—á–µ–Ω—å –≤–∞–∂–Ω–æ (–ø–æ–±–µ–¥–∞ –≤ –≥–æ–Ω–∫–µ, –ø–æ—É–ª, –∑–Ω–∞—á–∏–º—ã–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–Ω–Ω–æ–≤–∞—Ü–∏–∏)
   - 6-7: –ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ (–ø—Ä–µ–¥–∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ä–∞—Å–∫–ª–∞–¥—ã, —Ç–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è, –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–æ–ª–∏–¥–æ–≤)
   - 4-5: –û–±—ã—á–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏ (–ø—Ä–µ—Å—Å-–∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–∏, —Ä—É—Ç–∏–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)
   - 1-3: –ú–∞–ª–æ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ (–ø—Ä–æ–º–æ, —Å–ø–æ–Ω—Å–æ—Ä—Å–∫–∏–µ –Ω–æ–≤–æ—Å—Ç–∏, –æ–±—â–∏–µ –∑–∞—è–≤–ª–µ–Ω–∏—è)

2. –ù–∞–ø–∏—à–∏ –∫—Ä–∞—Ç–∫–æ–µ —Å–∞–º–º–∞—Ä–∏ –Ω–∞ –†–£–°–°–ö–û–ú —è–∑—ã–∫–µ (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è), —á—Ç–æ–±—ã –±—ã–ª–æ –ø–æ–Ω—è—Ç–Ω–æ –æ —á—ë–º –Ω–æ–≤–æ—Å—Ç—å.

–í–µ—Ä–Ω–∏ –æ—Ç–≤–µ—Ç —Å—Ç—Ä–æ–≥–æ –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ ‚Äî –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤:
[
  {{
    "index": 0,
    "hype_score": 8,
    "summary_ru": "–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º"
  }},
  ...
]

–ù–æ–≤–æ—Å—Ç–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:
{json.dumps(news_list, ensure_ascii=False, indent=2)}
"""

    try:
        response = await client.chat.completions.create(
            model=OPENAI_MODEL,
            messages=[
                {"role": "system", "content": "–¢—ã –∞–Ω–∞–ª–∏—Ç–∏–∫ –§–æ—Ä–º—É–ª—ã 1. –û—Ç–≤–µ—á–∞–π —Å—Ç—Ä–æ–≥–æ –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ."},
                {"role": "user", "content": prompt}
            ],
            temperature=0.3,
            response_format={"type": "json_object"},
        )

        content = response.choices[0].message.content
        result = json.loads(content)

        # –ú–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫–∞–∫ {"results": [...]} –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ [...]
        if isinstance(result, dict):
            items_data = result.get("results") or result.get("news") or result.get("items") or list(result.values())[0]
        else:
            items_data = result

        for item_data in items_data:
            idx = item_data.get("index", -1)
            if 0 <= idx < len(news_items):
                news_items[idx].hype_score = item_data.get("hype_score", 0)
                summary_ru = item_data.get("summary_ru", "")
                if summary_ru:
                    news_items[idx].summary = summary_ru

        logger.info(f"–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ {len(items_data)} –Ω–æ–≤–æ—Å—Ç–µ–π —á–µ—Ä–µ–∑ ChatGPT")

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –Ω–æ–≤–æ—Å—Ç–µ–π —á–µ—Ä–µ–∑ ChatGPT: {e}")

    return news_items


async def generate_news_post(title: str, url: str, article_content: str) -> str:
    """
    –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç –¥–ª—è Telegram-–∫–∞–Ω–∞–ª–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.
    """
    prompt = f"""–¢—ã ‚Äî –∞–≤—Ç–æ—Ä Telegram-–∫–∞–Ω–∞–ª–∞ –æ –§–æ—Ä–º—É–ª–µ 1. –ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–∏–π, —è—Ä–∫–∏–π –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π –ø–æ—Å—Ç –¥–ª—è Telegram-–∫–∞–Ω–∞–ª–∞ –Ω–∞ –†–£–°–°–ö–û–ú —è–∑—ã–∫–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–æ–π –Ω–æ–≤–æ—Å—Ç–∏.

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –ü–æ—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫–æ—Ä–æ—Ç–∫–∏–º (3-6 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π)
- –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –≤–Ω–∏–º–∞–Ω–∏—è (–Ω–æ –Ω–µ –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª—è–π)
- –ù–∞—á–Ω–∏ —Å —è—Ä–∫–æ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞
- –î–æ–±–∞–≤—å –∫–ª—é—á–µ–≤—ã–µ —Ñ–∞–∫—Ç—ã
- –¢–æ–Ω ‚Äî –∂–∏–≤–æ–π, —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π, —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π
- –ù–ï –¥–æ–±–∞–≤–ª—è–π —Ö—ç—à—Ç–µ–≥–∏
- –ù–ï –¥–æ–±–∞–≤–ª—è–π —Å—Å—ã–ª–∫—É ‚Äî –æ–Ω–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

–ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞: {title}

–¢–µ–∫—Å—Ç —Å—Ç–∞—Ç—å–∏:
{article_content[:3000]}
"""

    try:
        response = await client.chat.completions.create(
            model=OPENAI_MODEL,
            messages=[
                {"role": "system", "content": "–¢—ã –∞–≤—Ç–æ—Ä –ø–æ–ø—É–ª—è—Ä–Ω–æ–≥–æ Telegram-–∫–∞–Ω–∞–ª–∞ –æ –§–æ—Ä–º—É–ª–µ 1. –ü–∏—à–∏ —è—Ä–∫–æ –∏ –ø–æ –¥–µ–ª—É."},
                {"role": "user", "content": prompt}
            ],
            temperature=0.7,
        )

        post = response.choices[0].message.content.strip()
        # –î–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫
        post += f"\n\nüîó –ò—Å—Ç–æ—á–Ω–∏–∫: {url}"
        return post

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ—Å—Ç–∞: {e}")
        return f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ—Å—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.\n\n–ò—Å—Ç–æ—á–Ω–∏–∫: {url}"
